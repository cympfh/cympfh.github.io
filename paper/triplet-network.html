<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Deep Metric Learning using Triplet Network</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../resources/css/c.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header class="page-header">
    <a href='index.html'><img src="../resources/img/identicon.png" style="position:relative; top:0.4em; width:1.3em;border-radius:0.8em;" /> paper/</a>
</header>
<header>
<h1 class="title">Deep Metric Learning using Triplet Network</h1>
</header>
<ul>
<li>
original paper: <a href=https://arxiv.org/abs/1412.6622>https://arxiv.org/abs/1412.6622</a>
</li>
</ul>
<div class="is-pulled-right">
<p><a class='tag is-blue' href=index.html#距離学習>距離学習</a> <a class='tag is-blue' href=index.html#類似度学習>類似度学習</a></p>
</div>
<h2 id="手法概要">手法概要</h2>
<p>類似度を学習するための Triplet network を提案する. Siamese network のある種の拡張になっている.</p>
<p>Siamese network の入力は2つのアイテムのペアと、その2つの類似度であったが、 Triplet network では名前の通り、入力がアイテムの三組になっている.</p>
<ul>
<li>入力はアイテムの三組 <span class="math inline">\((x, x^+, x^-)\)</span>
<ul>
<li><span class="math inline">\(x\)</span>: 適当なターゲット</li>
<li><span class="math inline">\(x^+\)</span>: <span class="math inline">\(x\)</span> と近い (類似してる) アイテム</li>
<li><span class="math inline">\(x^-\)</span>: <span class="math inline">\(x\)</span> と遠い (類似していない) アイテム</li>
</ul></li>
<li>これらを共通した一つのニューラネットワーク <span class="math inline">\(f\)</span> に通す
<ul>
<li><span class="math inline">\((x, x^+, x^-) \mapsto (f(x), f(x^+), f(x^-)) = (z, z^+, z^-)\)</span></li>
</ul></li>
</ul>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="242pt" height="190pt" viewBox="0.00 0.00 242.00 190.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 186)">
<title>
%3
</title>
<!-- x+ -->
<g id="node1" class="node">
<title>
x+
</title>
<text text-anchor="middle" x="45" y="-160.3" font-family="Times,serif" font-size="14.00">x+</text> </g> <!-- f --> <g id="node2" class="node">
<title>
f
</title>
<polygon fill="none" stroke="black" points="144,-109 90,-109 90,-73 144,-73 144,-109"/> <text text-anchor="middle" x="117" y="-87.3" font-family="Times,serif" font-size="14.00">f</text> </g> <!-- x+&#45;&gt;f --> <g id="edge1" class="edge">
<title>
x+-&gt;f
</title>
<path fill="none" stroke="black" d="M62.4292,-145.813C71.45,-136.917 82.613,-125.909 92.4879,-116.172"/> <polygon fill="black" stroke="black" points="95.0685,-118.542 99.7313,-109.029 90.1534,-113.558 95.0685,-118.542"/> </g> <!-- z+ --> <g id="node3" class="node">
<title>
z+
</title>
<text text-anchor="middle" x="27" y="-14.3" font-family="Times,serif" font-size="14.00">z+</text> </g> <!-- f&#45;&gt;z+ --> <g id="edge2" class="edge">
<title>
f-&gt;z+
</title>
<path fill="none" stroke="black" d="M95.2135,-72.8129C83.6059,-63.6558 69.1606,-52.26 56.5553,-42.3158"/> <polygon fill="black" stroke="black" points="58.6047,-39.4746 48.5859,-36.0288 54.2692,-44.9704 58.6047,-39.4746"/> </g> <!-- z --> <g id="node5" class="node">
<title>
z
</title>
<text text-anchor="middle" x="117" y="-14.3" font-family="Times,serif" font-size="14.00">z</text> </g> <!-- f&#45;&gt;z --> <g id="edge4" class="edge">
<title>
f-&gt;z
</title>
<path fill="none" stroke="black" d="M117,-72.8129C117,-64.7895 117,-55.0475 117,-46.0691"/> <polygon fill="black" stroke="black" points="120.5,-46.0288 117,-36.0288 113.5,-46.0289 120.5,-46.0288"/> </g> <!-- z&#45; --> <g id="node7" class="node">
<title>
z-
</title>
<text text-anchor="middle" x="207" y="-14.3" font-family="Times,serif" font-size="14.00">z-</text> </g> <!-- f&#45;&gt;z&#45; --> <g id="edge6" class="edge">
<title>
f-&gt;z-
</title>
<path fill="none" stroke="black" d="M138.786,-72.8129C150.394,-63.6558 164.839,-52.26 177.445,-42.3158"/> <polygon fill="black" stroke="black" points="179.731,-44.9704 185.414,-36.0288 175.395,-39.4746 179.731,-44.9704"/> </g> <!-- z+&#45;&gt;z --> <g id="edge7" class="edge">
<title>
z+-&gt;z
</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M54.003,-18C65.2905,-18 78.3867,-18 89.705,-18"/> <text text-anchor="middle" x="72" y="-24.8" font-family="Times,serif" font-size="14.00">d+</text> </g> <!-- x --> <g id="node4" class="node">
<title>
x
</title>
<text text-anchor="middle" x="117" y="-160.3" font-family="Times,serif" font-size="14.00">x</text> </g> <!-- x&#45;&gt;f --> <g id="edge3" class="edge">
<title>
x-&gt;f
</title>
<path fill="none" stroke="black" d="M117,-145.813C117,-137.789 117,-128.047 117,-119.069"/> <polygon fill="black" stroke="black" points="120.5,-119.029 117,-109.029 113.5,-119.029 120.5,-119.029"/> </g> <!-- z&#45;&gt;z&#45; --> <g id="edge8" class="edge">
<title>
z-&gt;z-
</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M144.003,-18C155.29,-18 168.387,-18 179.705,-18"/> <text text-anchor="middle" x="162" y="-24.8" font-family="Times,serif" font-size="14.00">d-</text> </g> <!-- x&#45; --> <g id="node6" class="node">
<title>
x-
</title>
<text text-anchor="middle" x="189" y="-160.3" font-family="Times,serif" font-size="14.00">x-</text> </g> <!-- x&#45;&#45;&gt;f --> <g id="edge5" class="edge">
<title>
x--&gt;f
</title>
<path fill="none" stroke="black" d="M171.571,-145.813C162.55,-136.917 151.387,-125.909 141.512,-116.172"/> <polygon fill="black" stroke="black" points="143.847,-113.558 134.269,-109.029 138.932,-118.542 143.847,-113.558"/> </g> </g>
</svg>
<p>このときに <span class="math inline">\((x, x^+)\)</span> 及び <span class="math inline">\((x, x^-)\)</span> に関して Siamese network 的なことを行う.</p>
<p>すなわち、</p>
<ul>
<li><span class="math inline">\(x, x^+\)</span> 間の距離 (<span class="math inline">\(d^+\)</span> とする) をゼロにすること</li>
<li><span class="math inline">\(x, x^-\)</span> 間の距離 (<span class="math inline">\(d^-\)</span> とする) は適度に離れてること</li>
</ul>
<p>を目指す.</p>
<p>このアイテム間の距離として、<span class="math inline">\(z=f(x)\)</span> 同士の L2 距離を算出し、さらに次のように正規化を行う.</p>
<p><span class="math display">\[d^+ = \frac{\exp \| z - z^+ \| }{\exp \| z - z^+ \| + \exp \| z - z^- \| }\]</span> <span class="math display">\[d^- = \frac{\exp \| z - z^- \| }{\exp \| z - z^+ \| + \exp \| z - z^- \| }\]</span></p>
<p>すなわち、 <span class="math inline">\(d^+ + d^- = 1\)</span> となるように正規化する. <span class="math inline">\(d^+ = 0\)</span> のとき、<span class="math inline">\(d^- = 1\)</span> となるべきなので、損失は次のようにする. これを triplet loss という.</p>
<ul>
<li><span class="math inline">\(L(x, x^+, x^-) = d(y, y^+)^2 + (1 - d(y, y^-))^2\)</span></li>
</ul>
<p>いま <span class="math inline">\(d^+ + d^- = 1\)</span> としてるので</p>
<ul>
<li><span class="math inline">\(L(x, x^+, x^-) = 2 d(y, y^+)^2\)</span></li>
</ul>
<p>となって結局、<span class="math inline">\(d^+\)</span> の最小化、または <span class="math inline">\(d^-\)</span> の最大化と一致する.</p>
<h3 id="亜種">亜種?</h3>
<p>この論文を読むより先に &quot;triplet loss&quot; でググってヒットした <a href="http://tech.vasily.jp/entry/detection_and_retrieval#f-44448e46">ディープラーニングによるファッションアイテム検出と検索 - VASILY DEVELOPERS BLOG</a> という記事を読んでおり、その記事では損失関数として、</p>
<ul>
<li><span class="math inline">\(L(x, x^+, x^-) = \max \{ d(y, y^+) - d(y, y^-) - margin, 0 \}\)</span>
<ul>
<li><span class="math inline">\(d\)</span> は L2距離</li>
</ul></li>
</ul>
<p>というのが &quot;triplet loss&quot; だとして紹介されていた. どうも &quot;contrastive loss&quot; との折衷に見える.</p>
<p>恐らく、これは <a href="https://arxiv.org/abs/1503.03832">FaceNet</a> で &quot;triplet loss&quot; として提案されたもののことだろう. 論文が出た順で言うと、本文書で紹介している論文のほうが古い.</p>
<h2 id="評価実験">評価実験</h2>
<ul>
<li>Siamese ネットワークとの比較をしている.
<ul>
<li>MNIST/Cifar10/SVHN/STL10 でラベルの同一性に関して類似度を学習、埋め込み表現を得てその後は線形SVMまたはk近傍で分類をした.</li>
<li>まあ、そんな良くない</li>
</ul></li>
</ul>
<h2 id="感想">感想</h2>
<ul>
<li>初めに訓練データを三組に直す処理が必要で、実際に試そうと思うとすこし面倒くさい
<ul>
<li>場合によってはラベル付きデータを用意するより楽かもしれない
<ul>
<li>「同じラベルがついているペア」というものを探しさえすればいいので</li>
<li>「異なるラベルがついているペア」というのは簡単なヒューリスティックで作りやすい
<ul>
<li>ランダムに選べば大抵異なるラベルであるかもしれない</li>
</ul></li>
</ul></li>
</ul></li>
<li>三組を用意することは、Siamese Network で、ポジティブとネガティブとを均等に学習させられる利点である</li>
<li>実際に距離を、ポジティブとネガティブとの比にしていることの良さは、ネガティブとの距離を具体的に決めなくていいことである
<ul>
<li>直感的に、ポジティブとは近ければ近いほど良く、距離ゼロという教師データが使えるが、ネガティブの場合は、ある一定上離れてくれてば良いだけなので、どれだけの距離が適切なのか分からない
<ul>
<li>&quot;contrastive loss&quot; は、一定以上 (マージン) 離れてればゼロになるような損失関数である</li>
</ul></li>
</ul></li>
<li>評価実験について
<ul>
<li>毎回思うが、距離/類似度学習は分類のための手法ではないと思う</li>
</ul></li>
</ul>
<!--

  HTML として pandoc -B で include する.

  <H2> を列挙してそれらにリンクを貼った toc を id='toc' に埋め込む.
  markdown で書いてるだろうから例として次のような段落を書けばよい.

```
## INDEX
<div id=toc></div>
```

  used in
  - /memo/gnuplot
  - /memo/linux
  - /memo/imagemagick

-->
<script>
(function() {
  var sections = document.getElementsByTagName('h2');
  var i;
  var OL = document.createElement('ol');
  for (i=0; i < sections.length; ++i) {
    var LI = document.createElement('li');
    var A = document.createElement('a');
    A.innerHTML = sections[i].innerHTML;
    if (A.innerHTML.toUpperCase() == 'INDEX') continue;
    A.href = '#' + i;
    LI.appendChild(A);
    OL.appendChild(LI);

    var PREF = document.createElement('a');
    PREF.name = i;
    sections[i].appendChild(PREF);
  }

  var done = false;
  function work() {
    if (done) return;
    if ( document.getElementById('toc') === null) return; // no toc element
    document.getElementById('toc').appendChild(OL);
    done = true;
  };

  window.onload = work;
  setTimeout(work,800);
}());
</script>
</body>
</html>

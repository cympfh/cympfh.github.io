<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alarm</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d0d0f;
      --surface: #1a1a1f;
      --surface2: #22222a;
      --border: #333344;
      --text: #e8e8f0;
      --text-muted: #6666aa;
      --accent: #7766ff;
      --accent-glow: #7766ff44;
      --danger: #ff4466;
      --danger-glow: #ff446644;
      --success: #44ffaa;
      --success-glow: #44ffaa44;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', 'Menlo', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      padding: 1rem;
    }

    /* ---- Settings Panel ---- */
    .settings {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem 1rem;
      max-width: 640px;
      width: 100%;
    }

    .settings label {
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .settings input[type="text"],
    .settings select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      padding: 0.35rem 0.55rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .settings input[type="text"] {
      width: 5.5rem;
      text-align: center;
      letter-spacing: 0.1em;
    }

    .settings input[type="text"].invalid {
      border-color: var(--danger);
      color: var(--danger);
    }

    .settings input[type="text"]:focus,
    .settings select:focus {
      border-color: var(--accent);
    }

    .toggle-field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      align-items: flex-start;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .settings input[type="number"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      padding: 0.35rem 0.55rem;
      outline: none;
      transition: border-color 0.2s;
      width: 4.5rem;
      text-align: right;
    }

    .settings input[type="number"]:focus {
      border-color: var(--accent);
    }

    .settings input[type="number"]::-webkit-inner-spin-button,
    .settings input[type="number"]::-webkit-outer-spin-button {
      opacity: 0.4;
    }

    .autostop-sec {
      display: none;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .autostop-sec.visible {
      display: flex;
    }

    .toggle {
      position: relative;
      width: 42px;
      height: 22px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 99px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: var(--text-muted);
      border-radius: 50%;
      transition: transform 0.2s, background 0.2s;
    }

    .toggle input:checked + .toggle-track {
      background: var(--accent-glow);
      border-color: var(--accent);
    }

    .toggle input:checked + .toggle-track::after {
      transform: translateX(20px);
      background: var(--accent);
    }

    .apply-btn {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: bold;
      letter-spacing: 0.1em;
      padding: 0.5rem 1.1rem;
      text-transform: uppercase;
      transition: opacity 0.2s, box-shadow 0.2s;
      margin-left: auto;
    }

    .apply-btn:hover {
      opacity: 0.85;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .apply-btn:active {
      opacity: 0.7;
    }

    /* ---- Clock Area ---- */
    .clock-area {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.2rem;
    }

    .current-time {
      font-size: clamp(3rem, 15vw, 7rem);
      font-weight: bold;
      letter-spacing: 0.04em;
      color: var(--text);
      line-height: 1;
      text-shadow: 0 0 30px var(--accent-glow);
      transition: text-shadow 0.5s;
    }

    .current-time.ringing {
      color: var(--danger);
      text-shadow: 0 0 40px var(--danger-glow), 0 0 80px var(--danger-glow);
      animation: pulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      from { opacity: 1; }
      to   { opacity: 0.6; }
    }

    .countdown-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }

    .countdown-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .countdown {
      font-size: clamp(1.4rem, 6vw, 2.8rem);
      color: var(--accent);
      letter-spacing: 0.06em;
      transition: color 0.3s;
    }

    .countdown.near {
      color: var(--danger);
      animation: pulse 1s ease-in-out infinite alternate;
    }

    .countdown.no-alarm {
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* ---- Status Badge ---- */
    .status-badge {
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 0.25rem 0.8rem;
      border-radius: 99px;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: var(--surface);
      transition: all 0.3s;
    }

    .status-badge.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .status-badge.ringing {
      border-color: var(--danger);
      color: var(--danger);
      background: var(--danger-glow);
      animation: pulse 0.4s ease-in-out infinite alternate;
    }

    /* ---- Stop Button ---- */
    .stop-btn {
      display: none;
      background: var(--danger);
      border: none;
      border-radius: 999px;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      font-weight: bold;
      letter-spacing: 0.1em;
      padding: 0.8rem 2.4rem;
      text-transform: uppercase;
      transition: opacity 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 24px var(--danger-glow);
    }

    .stop-btn.visible {
      display: block;
    }

    .stop-btn:hover {
      opacity: 0.85;
      box-shadow: 0 0 40px var(--danger-glow);
    }

    /* ---- URL hint ---- */
    .url-hint {
      font-size: 0.6rem;
      color: var(--text-muted);
      opacity: 0.5;
      letter-spacing: 0.05em;
      max-width: 600px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="settings">
    <div class="field">
      <label for="inp-time">Time (HH:MM[:SS])</label>
      <input type="text" id="inp-time" value="07:00" placeholder="07:30" maxlength="8" pattern="\d{2}:\d{2}(:\d{2})?">
    </div>

    <div class="field">
      <label for="inp-sound">Sound</label>
      <select id="inp-sound">
        <option value="beep">Beep</option>
        <option value="bell">Bell</option>
        <option value="chime">Chime</option>
        <option value="siren">Siren</option>
        <option value="pulse">Pulse</option>
      </select>
    </div>

    <div class="toggle-field">
      <label>Auto Stop</label>
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="inp-auto" checked>
          <span class="toggle-track"></span>
        </label>
        <span class="autostop-sec visible" id="autostop-sec-wrap">
          <input type="number" id="inp-autostop-sec" value="5" min="1" max="3600">
          <span>sec</span>
        </span>
      </div>
    </div>

    <button class="apply-btn" id="apply-btn">Set</button>
  </div>

  <div class="clock-area">
    <div class="current-time" id="current-time">00:00:00</div>

    <div class="countdown-wrap">
      <div class="countdown-label">until alarm</div>
      <div class="countdown no-alarm" id="countdown">--:--</div>
    </div>

    <div class="status-badge" id="status-badge">no alarm</div>

    <button class="stop-btn" id="stop-btn">Stop</button>
  </div>

  <div class="url-hint">
    URL params: ?time=07:30 or ?time=07:30:00&amp;sound=bell&amp;autoStop=30
  </div>

  <script>
    // ---- Audio Engine ----
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let actx = null;
    let alarmNodes = [];

    function getAudioCtx() {
      if (!actx) actx = new AudioCtx();
      return actx;
    }

    const sounds = {
      beep: (ctx, t) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, t);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
        osc.start(t);
        osc.stop(t + 0.2);
        return [osc, gain];
      },
      bell: (ctx, t) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1320, t);
        gain.gain.setValueAtTime(0.4, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
        osc.start(t);
        osc.stop(t + 1.3);
        return [osc, gain];
      },
      chime: (ctx, t) => {
        const freqs = [523, 659, 784, 1047];
        const nodes = [];
        freqs.forEach((f, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(f, t + i * 0.15);
          gain.gain.setValueAtTime(0, t);
          gain.gain.setValueAtTime(0.25, t + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.15 + 0.8);
          osc.start(t);
          osc.stop(t + i * 0.15 + 0.9);
          nodes.push(osc, gain);
        });
        return nodes;
      },
      siren: (ctx, t) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(400, t);
        osc.frequency.linearRampToValueAtTime(1200, t + 0.4);
        osc.frequency.linearRampToValueAtTime(400, t + 0.8);
        gain.gain.setValueAtTime(0.25, t);
        gain.gain.setValueAtTime(0.25, t + 0.75);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.82);
        osc.start(t);
        osc.stop(t + 0.85);
        return [osc, gain];
      },
      pulse: (ctx, t) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(660, t);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.setValueAtTime(0.3, t + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
        osc.start(t);
        osc.stop(t + 0.12);
        return [osc, gain];
      },
    };

    const soundIntervals = {
      beep:  0.4,
      bell:  1.8,
      chime: 2.0,
      siren: 1.1,
      pulse: 0.25,
    };

    let ringingIntervalId = null;

    function playSound(soundName) {
      const ctx = getAudioCtx();
      if (ctx.state === 'suspended') ctx.resume();
      const fn = sounds[soundName] || sounds.beep;
      const nodes = fn(ctx, ctx.currentTime);
      alarmNodes.push(...nodes);
    }

    function startRinging(soundName) {
      if (ringingIntervalId) return;
      playSound(soundName);
      const interval = (soundIntervals[soundName] || 0.5) * 1000;
      ringingIntervalId = setInterval(() => playSound(soundName), interval);
    }

    function stopRinging() {
      if (ringingIntervalId) {
        clearInterval(ringingIntervalId);
        ringingIntervalId = null;
      }
      alarmNodes.forEach(n => {
        try { n.stop && n.stop(); } catch(_) {}
        try { n.disconnect && n.disconnect(); } catch(_) {}
      });
      alarmNodes = [];
    }

    // ---- State ----
    let alarm = null; // { h, m, s } or null
    let soundName = 'beep';
    let autoStop = 5; // seconds; 0以下なら自動停止しない
    let isRinging = false;
    let autoStopTimer = null;
    let lastAlarmDate = null; // 鳴らした日付

    // ---- DOM ----
    const elTime    = document.getElementById('current-time');
    const elCountdown = document.getElementById('countdown');
    const elBadge   = document.getElementById('status-badge');
    const elStop    = document.getElementById('stop-btn');
    const inpTime   = document.getElementById('inp-time');
    const inpSound  = document.getElementById('inp-sound');
    const inpAuto       = document.getElementById('inp-auto');
    const inpAutoSec    = document.getElementById('inp-autostop-sec');
    const autoSecWrap   = document.getElementById('autostop-sec-wrap');
    const applyBtn      = document.getElementById('apply-btn');

    // ---- Format helpers ----
    function pad2(n) { return String(n).padStart(2, '0'); }

    function formatCountdown(totalSec) {
      if (totalSec < 0) totalSec += 86400;
      const h = Math.floor(totalSec / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      if (h > 0) return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
      return `${pad2(m)}:${pad2(s)}`;
    }

    // ---- Apply settings ----
    function applySettings() {
      const val = inpTime.value.trim();
      const match = val.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
      if (!val || !match) {
        alarm = null;
        inpTime.classList.toggle('invalid', val.length > 0);
      } else {
        const h = Number(match[1]);
        const m = Number(match[2]);
        const s = match[3] !== undefined ? Number(match[3]) : 0;
        if (h > 23 || m > 59 || s > 59) {
          alarm = null;
          inpTime.classList.add('invalid');
        } else {
          alarm = { h, m, s };
          inpTime.classList.remove('invalid');
          inpTime.value = match[3] !== undefined
            ? `${pad2(h)}:${pad2(m)}:${pad2(s)}`
            : `${pad2(h)}:${pad2(m)}`;
        }
      }
      soundName = inpSound.value;
      if (inpAuto.checked) {
        autoStop = Math.max(1, parseInt(inpAutoSec.value, 10) || 5);
        inpAutoSec.value = autoStop;
      } else {
        autoStop = 0;
      }
      lastAlarmDate = null;
      stopAlarm();
      updateURL();
    }

    function updateURL() {
      const params = new URLSearchParams();
      if (alarm) {
        const t = alarm.s
          ? `${pad2(alarm.h)}:${pad2(alarm.m)}:${pad2(alarm.s)}`
          : `${pad2(alarm.h)}:${pad2(alarm.m)}`;
        params.set('time', t);
      }
      params.set('sound', soundName);
      params.set('autoStop', String(autoStop));
      history.replaceState(null, '', '?' + params.toString());
    }

    // ---- Load from URL ----
    function loadFromURL() {
      const params = new URLSearchParams(location.search);
      if (params.has('time')) {
        const t = params.get('time');
        const m = t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
        if (m) {
          const h = Number(m[1]);
          const min = Number(m[2]);
          const s = m[3] !== undefined ? Number(m[3]) : 0;
          alarm = { h, m: min, s };
          inpTime.value = m[3] !== undefined
            ? `${pad2(h)}:${pad2(min)}:${pad2(s)}`
            : `${pad2(h)}:${pad2(min)}`;
        }
      }
      if (params.has('sound')) {
        const s = params.get('sound');
        if (sounds[s]) {
          soundName = s;
          inpSound.value = s;
        }
      }
      if (params.has('autoStop')) {
        const v = parseInt(params.get('autoStop'), 10);
        autoStop = isNaN(v) ? 5 : v;
        inpAuto.checked = autoStop > 0;
        if (autoStop > 0) {
          inpAutoSec.value = autoStop;
          autoSecWrap.classList.add('visible');
        } else {
          autoSecWrap.classList.remove('visible');
        }
      }
    }

    // ---- Alarm trigger ----
    function triggerAlarm() {
      isRinging = true;
      elTime.classList.add('ringing');
      elBadge.textContent = 'ringing';
      elBadge.className = 'status-badge ringing';
      elStop.classList.add('visible');
      startRinging(soundName);

      if (autoStop > 0) {
        autoStopTimer = setTimeout(() => stopAlarm(), autoStop * 1000);
      }
    }

    function stopAlarm() {
      if (autoStopTimer) { clearTimeout(autoStopTimer); autoStopTimer = null; }
      isRinging = false;
      stopRinging();
      elTime.classList.remove('ringing');
      elStop.classList.remove('visible');
      if (alarm) {
        elBadge.textContent = 'set';
        elBadge.className = 'status-badge active';
      } else {
        elBadge.textContent = 'no alarm';
        elBadge.className = 'status-badge';
      }
    }

    // ---- Tick ----
    function tick() {
      const now = new Date();
      const hh = now.getHours();
      const mm = now.getMinutes();
      const ss = now.getSeconds();
      const ms = now.getMilliseconds();

      // current time display
      elTime.textContent = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;

      if (!alarm) {
        elCountdown.textContent = '--:--';
        elCountdown.className = 'countdown no-alarm';
        elBadge.textContent = 'no alarm';
        elBadge.className = 'status-badge';
        return;
      }

      const nowSec = hh * 3600 + mm * 60 + ss;
      const alarmSec = alarm.h * 3600 + alarm.m * 60 + (alarm.s || 0);
      let diff = alarmSec - nowSec;
      if (diff < 0) diff += 86400;

      // Check trigger: diff == 0 かつ今日まだ鳴らしていない
      const today = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;
      if (diff === 0 && !isRinging && lastAlarmDate !== today) {
        lastAlarmDate = today;
        triggerAlarm();
      }

      if (!isRinging) {
        elCountdown.textContent = formatCountdown(diff);
        elCountdown.className = diff <= 60 ? 'countdown near' : 'countdown';
        elBadge.textContent = 'set';
        elBadge.className = 'status-badge active';
      } else {
        elCountdown.textContent = 'RINGING';
        elCountdown.className = 'countdown near';
      }
    }

    // ---- Time input: auto-colon & validation ----
    inpTime.addEventListener('input', (e) => {
      let v = e.target.value.replace(/[^\d:]/g, '');
      // 数字2文字打ったらコロンを自動挿入（HH: と HH:MM:）
      if (/^\d{2}$/.test(v)) v = v + ':';
      if (/^\d{2}:\d{2}$/.test(v)) v = v + ':';
      e.target.value = v;
      const validShort = /^\d{2}:\d{2}$/.test(v);
      const validLong  = /^\d{2}:\d{2}:\d{2}$/.test(v);
      const tooLong = v.length > 5;
      inpTime.classList.toggle('invalid', tooLong && !validShort && !validLong);
    });

    // ---- Events ----
    inpAuto.addEventListener('change', () => {
      autoSecWrap.classList.toggle('visible', inpAuto.checked);
    });

    applyBtn.addEventListener('click', applySettings);

    elStop.addEventListener('click', () => {
      stopAlarm();
      // 止めた後もアラームは維持（翌日また鳴る）
    });

    // ---- Init ----
    loadFromURL();
    if (alarm) {
      elBadge.textContent = 'set';
      elBadge.className = 'status-badge active';
    }
    tick();
    setInterval(tick, 500);
  </script>
</body>
</html>

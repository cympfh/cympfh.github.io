# 混合行列 (confusion matrix, heatmap)

## 参考

- [gnuplot demo script: heatmaps.dem](http://gnuplot.sourceforge.net/demo_svg/heatmaps.html)

## 概要

混合行列 (Confusion Matrix) などと呼ばれるあの表を色付きで図示する.
色の濃さで数の大きさを表現する.

上の参考リンクでは色が連続して変化するように中間値補完が為されてるが、
私の知ってるgnuplotのバージョンではこれは再現できない.
これをするには `pm3d` を使ったほうがいいと思う.

![](3d.heatmap.png)

## 方法

### data format

行列 (`matrix`) 形式でデータを与えることにする.
すなわち、データ $z$ を $n$ 行 $m$ 列に並べたものをデータとする.

```dat
z11 z12 z13
z21 z22 z23
z31 z32 z33
z41 z42 z43
```

混合行列を図示する目的のためには行と列とに見出し (座標ではなくラベル) があるべきで、
どうせならデータに含めたい.
gnuplot の matrix data は行ごとのアイテム数は揃ってる必要があるので、
0行目0列目にはダミーデータを入れた上で、
1行目または1列目に見出しを入れられる.

```dat
xxxx Col1 Col2 Col3
Row1  z11  z12  z13
Row2  z21  z22  z23
Row3  z31  z32  z33
Row4  z41  z42  z43
```

### `with image`

```bash
plot ... using <x>:<y>:<z> with image
```

| params           | default       | value          | explanation |
| :--------------- | :-----------: | :------------- | :---------- |
| `x` | -- | (int)     | データの $x$ 座標 |
| `y` | -- | (int)     | データの $y$ 座標 |
| `z` | -- | (double)  | データ. 対応する色が塗られる |

ただし、matrix で読む場合は `x`, `y` は自動的に column 1, 2 として適切な値が入ってると見なしてよい.

### `columnheaders`, `rowheaders`

```bash
plot ... matrix column rowheaders
```

データの一行目、一列目の文字列を見出しだと思って、
二行目、二列目以降のデータだけを使う.

### example

@[data](3d.heatmap.dat)
@[bash](3d.heatmap.gp)

![](3d.heatmap.png)

## 格子線 (gridline)

`set grid` によってセル同士の境界に線を引く.
デフォルトだとセルの色塗りは gridline の後に行われて上書きされるので `set grid front` とする.
`lt` や `lc`, `lw` で線のスタイルは調整する.

@[bash](3d.heatmap.grid.ng.gp)
![](3d.heatmap.grid.ng.png)

`xy` に gridline を引いてもちょうど 0.5 ずれた、セルの真ん中に引くようになってしまう.
なぜならセルはちょうど格子点から `(-0.5, -0.5)-(0.5, 0.5)` の領域を占めているから.

ちょうど 0.5 ずらした格子線を手に入れるために小目盛り (minor tics) を利用する.
ただし `xy` の大目盛りがラベルのために使われている (数値で指定されていない) ときは小目盛りは使えないことになっているので、
`x2y2` を使う.

まず `x2, y2` を宣言し `set link` で `xy` と同期させる.
これに小目盛り `mx2, my2` を `interval=2` で宣言することで、ちょうど半分に分割する目盛りを作れる.
`grid` の引数に `mx2tics, my2tics` を追加すればよい.

変更点だけ書き出すと次の通り.
@[bash](3d.heatmap.grid.change.gp)

最後に余計なラベルや刻み線を消す処理を追加して結局

@[bash](3d.heatmap.grid.gp)
![](3d.heatmap.grid.png)

となった.

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Mon Sep 14 02:29:58 JST 2015</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../resources/css/c.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>
<body>
<header class="page-header">
    <a href='../../index.html'><i class="fa fa-save" style="position:absolute; left:0.4em; top:0.4em; width:1.3em;border-radius:0.8em;"></i></a>
</header>
<header>
<h1 class="title">Mon Sep 14 02:29:58 JST 2015</h1>
</header>
<h2 id="beamerスライドでプログレスバーを出す">beamerスライドでプログレスバーを出す</h2>
<p>スライドの一番下のところに、 今示してるページは全体の何割あたりのところであるかを、 棒で可視化するやつ</p>
<p><img src="../../img/2015/0914-progressbar.jpg" /></p>
<p>プリアンブルに次を書いておく. もちろん、<code>usetheme</code> を呼んだ後でないと上書きされる.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode tex"><code class="sourceCode latex"><a class="sourceLine" id="cb1-1" title="1"><span class="co">%%% FOOTER</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="fu">\makeatother</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="fu">\setbeamertemplate</span>{footline}</a>
<a class="sourceLine" id="cb1-4" title="4">{</a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="fu">\dimen</span>0=1.1<span class="fu">\paperwidth</span></a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="fu">\multiply\dimen</span>0 by <span class="fu">\insertframenumber</span></a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="fu">\divide\dimen</span>0 by <span class="fu">\inserttotalframenumber</span></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="fu">\edef</span>\progressbarwidth{\the\dimen0}</a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="fu">\leavevmode</span><span class="co">%</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="fu">\setbeamercolor</span>{progress outer}{fg=white, bg=white}</a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="fu">\setbeamercolor</span>{progress bar}{bg=pink!90!white}</a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="kw">\begin</span>{<span class="ex">beamercolorbox</span>}[wd=1.1<span class="fu">\paperwidth</span>,ht=0.25ex,dp=1ex]{progress outer}</a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="kw">\begin</span>{<span class="ex">beamercolorbox</span>}[wd=<span class="fu">\progressbarwidth</span>,ht=0.25ex,dp=1ex]{progress bar}</a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="kw">\end</span>{<span class="ex">beamercolorbox</span>}<span class="co">%</span></a>
<a class="sourceLine" id="cb1-15" title="15">  <span class="kw">\end</span>{<span class="ex">beamercolorbox</span>}<span class="co">%</span></a>
<a class="sourceLine" id="cb1-16" title="16">}</a>
<a class="sourceLine" id="cb1-17" title="17"><span class="fu">\makeatletter</span></a></code></pre></div>
<p>本来、1.1という数字は要らないのだけど、なんか左右に余白が勝手にできるので (どっかでいじった？).</p>
<p>ついでながら、 ページ番号は、ナビゲーションの代わりに挿入させてる.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode tex"><code class="sourceCode latex"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">\setbeamertemplate</span>{navigation symbols}{</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="fu">\setbeamercolor</span>{footline}{fg=pink!90!white}</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="fu">\usebeamerfont</span>{footline}<span class="co">%</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="fu">\usebeamercolor</span>[fg]{footline}<span class="co">%</span></a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="fu">\hspace</span>{1em}</a>
<a class="sourceLine" id="cb2-6" title="6">  <span class="fu">\fontsize</span>{2.8em}{2.8em}<span class="fu">\selectfont</span></a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="fu">\rotatebox</span>{90}{<span class="fu">\insertframenumber</span>}</a></code></pre></div>
<p>オシャレのつもりで90度回転させてるけど、どうだろう…</p>
<h2 id="mon-sep-14-212125-jst-2015">Mon Sep 14 21:21:25 JST 2015</h2>
<h3 id="scala-の-list.diff-が遅い">Scala の List.diff が遅い</h3>
<p>といっても、クイックソートと基数ソートを比べるようなものだけど…</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">import</span> scala.<span class="fu">math</span>._</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">import</span> scala.<span class="fu">collection</span>.<span class="fu">mutable</span>.{Queue, Set}</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">import</span> scala.<span class="fu">collection</span>.<span class="fu">immutable</span>._</a>
<a class="sourceLine" id="cb3-4" title="4"> </a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">object</span> Main {</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="co">// 時間計測</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="kw">def</span> <span class="fu">thetime</span>(proc: () =&gt; Unit): Unit = {</a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="kw">val</span> start = System.<span class="fu">currentTimeMillis</span></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="fu">proc</span>()</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="fu">println</span>((System.<span class="fu">currentTimeMillis</span> - start) + <span class="st">&quot;msec&quot;</span>)</a>
<a class="sourceLine" id="cb3-12" title="12">  }</a>
<a class="sourceLine" id="cb3-13" title="13"></a>
<a class="sourceLine" id="cb3-14" title="14">  <span class="co">// 関数型っぽい普通の差分</span></a>
<a class="sourceLine" id="cb3-15" title="15">  <span class="co">// ただしソート済みであることを前提とする</span></a>
<a class="sourceLine" id="cb3-16" title="16">  <span class="kw">def</span> <span class="fu">difference</span>(xs: List[Int], ys: List[Int]): List[Int] = {</a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="kw">def</span> <span class="fu">sub</span>(ac: List[Int], xs: List[Int], ys: List[Int]): List[Int] = {</a>
<a class="sourceLine" id="cb3-18" title="18">      <span class="kw">if</span> (xs.<span class="fu">length</span> == <span class="dv">0</span>) ac.<span class="fu">reverse</span></a>
<a class="sourceLine" id="cb3-19" title="19">      <span class="kw">else</span> <span class="kw">if</span> (ys.<span class="fu">length</span> == <span class="dv">0</span>) ac.<span class="fu">reverse</span> ++ xs</a>
<a class="sourceLine" id="cb3-20" title="20">      <span class="kw">else</span> <span class="kw">if</span> (xs.<span class="fu">head</span> == ys.<span class="fu">head</span>) <span class="fu">sub</span>(ac, xs.<span class="fu">tail</span>, ys.<span class="fu">tail</span>)</a>
<a class="sourceLine" id="cb3-21" title="21">      <span class="kw">else</span> <span class="kw">if</span> (xs.<span class="fu">head</span> &gt; ys.<span class="fu">head</span>) <span class="fu">sub</span>(ac, xs, ys.<span class="fu">tail</span>)</a>
<a class="sourceLine" id="cb3-22" title="22">      <span class="kw">else</span> <span class="fu">sub</span>(xs.<span class="fu">head</span> :: ac, xs.<span class="fu">tail</span>, ys)</a>
<a class="sourceLine" id="cb3-23" title="23">    }</a>
<a class="sourceLine" id="cb3-24" title="24">    <span class="fu">sub</span>(List(), xs, ys)</a>
<a class="sourceLine" id="cb3-25" title="25">  }</a>
<a class="sourceLine" id="cb3-26" title="26"></a>
<a class="sourceLine" id="cb3-27" title="27">  <span class="co">// 一回配列 [Bool] にしてから差分を出す</span></a>
<a class="sourceLine" id="cb3-28" title="28">  <span class="co">// ただし、リストの要素が [0 ... n] であることを前提とする</span></a>
<a class="sourceLine" id="cb3-29" title="29">  <span class="co">// (基数ソートっぽい)</span></a>
<a class="sourceLine" id="cb3-30" title="30">  <span class="kw">def</span> <span class="fu">viaArray</span>(n: Int, xs: List[Int], ys: List[Int]): List[Int] = {</a>
<a class="sourceLine" id="cb3-31" title="31">    <span class="kw">val</span> a = Array.<span class="fu">fill</span>(n)(<span class="kw">false</span>)</a>
<a class="sourceLine" id="cb3-32" title="32">    <span class="kw">val</span> b = Array.<span class="fu">fill</span>(n)(<span class="kw">false</span>)</a>
<a class="sourceLine" id="cb3-33" title="33">    <span class="kw">for</span> (x &lt;- xs) <span class="fu">a</span>(x) = <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-34" title="34">    <span class="kw">for</span> (y &lt;- ys) <span class="fu">b</span>(y) = <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-35" title="35">    <span class="kw">var</span> ret = List[Int]()</a>
<a class="sourceLine" id="cb3-36" title="36">    <span class="kw">for</span> (i &lt;- <span class="dv">0</span> until n) <span class="kw">if</span> ((!<span class="fu">a</span>(i)) &amp;&amp; <span class="fu">b</span>(i)) ret = i :: ret</a>
<a class="sourceLine" id="cb3-37" title="37">    ret</a>
<a class="sourceLine" id="cb3-38" title="38">  }</a>
<a class="sourceLine" id="cb3-39" title="39"></a>
<a class="sourceLine" id="cb3-40" title="40">  <span class="kw">def</span> <span class="fu">main</span>(args: Array[String]) {</a>
<a class="sourceLine" id="cb3-41" title="41">    <span class="kw">val</span> cin = <span class="kw">new</span> java.<span class="fu">util</span>.<span class="fu">Scanner</span>(System.<span class="fu">in</span>)</a>
<a class="sourceLine" id="cb3-42" title="42"></a>
<a class="sourceLine" id="cb3-43" title="43">    <span class="kw">val</span> a: List[Int] = <span class="fu">Range</span>(<span class="dv">0</span>, <span class="dv">100000</span>) toList</a>
<a class="sourceLine" id="cb3-44" title="44">    <span class="kw">val</span> b: List[Int] = <span class="fu">Range</span>(<span class="dv">100</span>, <span class="dv">10000</span>) toList</a>
<a class="sourceLine" id="cb3-45" title="45">    <span class="kw">val</span> c: List[Int] = <span class="fu">Range</span>(<span class="dv">10</span>, <span class="dv">1000</span>) toList</a>
<a class="sourceLine" id="cb3-46" title="46">    <span class="kw">def</span> <span class="fu">a1</span>(): Unit = <span class="fu">println</span>((a diff b).<span class="fu">length</span>) <span class="co">// 10^5 * 10^4</span></a>
<a class="sourceLine" id="cb3-47" title="47">    <span class="kw">def</span> <span class="fu">a2</span>(): Unit = <span class="fu">println</span>((b diff c).<span class="fu">length</span>) <span class="co">// 10^4 * 10^3</span></a>
<a class="sourceLine" id="cb3-48" title="48">    <span class="kw">def</span> <span class="fu">b1</span>(): Unit = <span class="fu">println</span>(<span class="fu">difference</span>(a, b).<span class="fu">length</span>)</a>
<a class="sourceLine" id="cb3-49" title="49">    <span class="kw">def</span> <span class="fu">b2</span>(): Unit = <span class="fu">println</span>(<span class="fu">difference</span>(b, c).<span class="fu">length</span>)</a>
<a class="sourceLine" id="cb3-50" title="50">    <span class="kw">def</span> <span class="fu">c1</span>(): Unit = <span class="fu">println</span>(<span class="fu">viaArray</span>(<span class="dv">100001</span>, a, b).<span class="fu">length</span>)</a>
<a class="sourceLine" id="cb3-51" title="51">    <span class="kw">def</span> <span class="fu">c2</span>(): Unit = <span class="fu">println</span>(<span class="fu">viaArray</span>(<span class="dv">100001</span>, b, c).<span class="fu">length</span>)</a>
<a class="sourceLine" id="cb3-52" title="52">    <span class="fu">thetime</span>(a1)</a>
<a class="sourceLine" id="cb3-53" title="53">    <span class="fu">thetime</span>(a2)</a>
<a class="sourceLine" id="cb3-54" title="54">    <span class="fu">thetime</span>(b1)</a>
<a class="sourceLine" id="cb3-55" title="55">    <span class="fu">thetime</span>(b2)</a>
<a class="sourceLine" id="cb3-56" title="56">    <span class="fu">thetime</span>(c1)</a>
<a class="sourceLine" id="cb3-57" title="57">    <span class="fu">thetime</span>(c2)</a>
<a class="sourceLine" id="cb3-58" title="58">  }</a>
<a class="sourceLine" id="cb3-59" title="59">}</a></code></pre></div>
<p>結果が以下のよう</p>
<pre><code># List.diff (組み込み)
90100
96msec
9000
3msec
# 自前 difference
90100
2956msec
9000
25msec
# 自前 differenceViaArray
90100
43msec
9000
2msec</code></pre>
<p>組み込み <code>diff</code> のソースコードがどこにあるのかわからないので読んでないのだが、 <code>differenceViaArray</code> に較べて 二倍程度 遅い. <code>a-b</code> と <code>b-c</code> を比べると、 <span class="math inline">\(O(n^2)\)</span> というわけでもないようだけれど.</p>
<p><code>thetime(() =&gt; println(0))</code> って書きたいんだけど、型エラーでコンパイルできない. なんだろう.</p>
<h2 id="mon-sep-14-022958-jst-2015">Mon Sep 14 02:29:58 JST 2015</h2>
<h3 id="簡易的な画像の自動分類を試す">簡易的な、画像の自動分類を試す</h3>
<p>画像識別といえばNNsだけど、 SIFTに代表されるような旧き良き画像特徴量を用いた 分類を行う.</p>
<h3 id="事前処理">事前処理</h3>
<p>扱いやすさのために次の情報をわざと失う</p>
<ul>
<li>色</li>
<li>比</li>
</ul>
<p>具体的には、 モノクロにし、比率を無視した200x200の大きさにリサイズして 出来た画像を、直接扱うことにする. また、輪郭だけを取り出したほうが良い特徴量が得られる気がするので、そのようにする.</p>
<blockquote>
<p>改良としては、色の情報を用いること. 画像にはカラー画像とモノクロ画像とがあるので、 まずどちらであるかを分類して、 それぞれで学習した異なる分類器を作るのが良いだろう. また、何で分類するかであるが、 例えば画像に写った顔で分類するなら、 顔を検出してそこだけ取り出すとかは、 普通すべきことだろう. 今回はそこまでするつもりはない.</p>
</blockquote>
<p>モノクロやリサイズはツールで簡単に出来るにしても、 輪郭を取り出すのはそんな簡単にできるだろうか、 とググったらすぐに見つかった. 今回は <a href="http://www.johf.com/log/20130304b.html">ImageMagick で写真の輪郭を取り出す - Oi!</a> を参考にする. そこに載ってるコマンドに <code>-reize</code> と <code>-monochrome</code> だけ追加して</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">convert</span> -resize 200x200! -segment 1x1 +dither -colors 2 -edge 1 -negate -monochrome in.jpg out.jpg</a></code></pre></div>
<p>となる.</p>
<p>さらに、<code>jpg</code> のようなバイナリだとそのままでは読めないので、 テキストとして読める <code>ppm</code> にすることにする.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="ex">convert</span> -resize 200x200! -segment 1x1 +dither -colors 2 -edge 1 -negate -monochrome -compress none in.jpg out.ppm</a></code></pre></div>
<p><img src="../../img/2015/0914-in.jpg" alt="in.jpg" /> <img src="../../img/2015/0914-out.jpg" alt="out.jpg" /></p>
<p>これで、画像はグレイスケールの行列 <span class="math inline">\(E\)</span> として表現される</p>
<p><span class="math display">\[0 \leq E_{i,j} \leq 255 (0 \leq i, j &lt; 400)\]</span></p>
<h3 id="画像特徴量">画像特徴量</h3>
<p>画像をさらに、画像に適した特徴量 (アフィン変換に不偏であるとか云々) に変換することが必要. ざっくりとどういうのがあるのかは <a href="http://www.slideshare.net/lawmn/siftsurf">画像認識の初歩、SIFT,SURF特徴量</a> を読むと良い.</p>
<p>最悪自分で実装しようと思ったが、 <a href="http://robwhess.github.io/opensift/">OpenSIFT: An Open-Source SIFT Library</a> てのがあったのでこれを用いる. ソースがurl先で配布されてるので自分でビルドして使う.</p>
<pre><code>./robwhess-opensift-6233815/bin/siftfeat -o hoge sample/out.ppm</code></pre>
<pre><code>Finding SIFT features...
Found 17 features.</code></pre>
<p><code>hoge</code> というテキストファイルが生成されて、 あとついでに、得られた特徴量を可視化したのであろう画像<br />
<img src="../../img/2015/0914-sift.jpg" /> が表示される (というか、たったの17個かぁ).</p>
<p>この <code>hoge</code> を元に、学習・分類すればよいわけである. どう使おう.</p>
<h3 id="hoge-ファイルの読み方"><code>hoge</code> ファイルの読み方</h3>
<p>頭のほうだけ見てみると</p>
<pre><code>17 128
46.330449 144.342443 9.258731 2.132983
 13 26 13 87 107 1 0 0 59 62 9 12 100 34 0 0 114 113 12 2
 63 34 2 4 23 45 22 9 35 83 7 7 32 12 2 23 117 87 11 5
 117 42 1 3 54 71 16 20 25 87 21 3 59 117 60 24 23 70 36 9
 6 7 49 90 3 0 0 0 40 117 40 5 83 27 8 2 25 87 42 29
 36 20 13 5 9 66 46 67 9 0 0 0 0 3 44 114 0 0 0 0
 12 25 1 0 3 6 2 0 35 74 33 17 28 6 3 0 0 4 22 96
 6 0 0 0 0 0 0 17
46.330449 144.342443 9.258731 -0.172558
 0 36 45 6 3 1 1 0 1 35 95 8 0 0 0 0 1 10 92 24
 :
 :</code></pre>
<p>つまりこういうことだろう. 一つの特徴量が <span class="math inline">\(N\)</span> 次元の特徴量が <span class="math inline">\(M\)</span> 個あるとき、 一行目は</p>
<pre><code>M N</code></pre>
<p>二行目以降、<span class="math inline">\(M\)</span> 個、データセットが複数行に渡って与えられる. 一つのデータセットはこう</p>
<pre><code>x y z w
 a1 a2 .. aN</code></pre>
<p><span class="math inline">\(x,y,z,w\)</span> が何を意味するのかよくわからない. 特徴量が見つかった点の座標と長さと、もうひとつは、角度？かな？</p>
<p><span class="math inline">\(a_1 ... a_N\)</span> が実際の、特徴量. 長さの情報はこちらに含まれるのでゎ？ まぁ、いいや、実際に使うのはこっちだけにしよう.</p>
<h3 id="学習データの整形">学習データの整形</h3>
<p>一つの画像から、<span class="math inline">\(M\)</span> 個の特徴量が見つかって、 全部合わせると <span class="math inline">\(NM\)</span> 次元の特徴量が見つかる. <span class="math inline">\(N\)</span> は <span class="math inline">\(128\)</span> で固定だけど、<span class="math inline">\(M\)</span> は画像によって異なる.</p>
<p>画像ごとに次元が違うのは困るので、 どうするのかというと、 確か、 大きいのから<span class="math inline">\(m\)</span>個拾ってくるということをすることで、 次元を揃える. 「大きい」ってどうやって見るんだろう. <code>hoge</code> を見ると、 データセットは <span class="math inline">\(x,y,z,w\)</span> の順に並んでるというわけでも ないようなので、「大きい」順に出力されてるのかもしれない. いやそうに違いない. <span class="math inline">\(m\)</span> 個に足りない場合は、ゼロで埋める.</p>
<p><code>hoge</code> を簡単に、学習用のデータにしよう. そもそも何の学習器を用いるか考えてないけど、 どうせ学習データのフォーマットはみんな決まってる.</p>
<p>bashスクリプトで書いてみる.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="va">m=</span>10 <span class="co"># 例えばね</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="fu">cat</span> hoge <span class="kw">|</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="fu">grep</span> <span class="st">&#39;^ &#39;</span> <span class="kw">|</span> <span class="co"># 使いたい特徴量はみんな空白で始まる行に書かれる</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="fu">grep</span> -o <span class="st">&#39;[0-9]*&#39;</span> <span class="kw">|</span> <span class="co"># 数字単位で改行</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="fu">head</span> -n <span class="va">$((</span> <span class="va">$m</span> * 128 <span class="va">))</span> <span class="kw">|</span> <span class="co"># 使うのは最初の m*128 個</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="fu">awk</span> <span class="st">&#39;{print $1 + 1}&#39;</span> <span class="kw">|</span> <span class="co"># 0-origin が出力されるので 1-originにする</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="fu">sort</span> -n <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="co"># 数える</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="fu">sed</span> <span class="st">&#39;s/^ *\([0-9]*\) \([0-9]*\)/\2:\1/&#39;</span> <span class="kw">|</span> <span class="co"># &lt;1-origin id&gt;:&lt;個数&gt; のフォーマットにする</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="fu">tr</span> <span class="st">&#39;\n\&#39;</span> <span class="st">&#39; &#39;</span> <span class="co"># 改行を空白に置換</span></a></code></pre></div>
<p>邪魔なコメントと改行を取り除くと下のようになる</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1"><span class="va">m=</span>10;</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="fu">cat</span> hoge <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;^ &#39;</span> <span class="kw">|</span> <span class="fu">grep</span> -o <span class="st">&#39;[0-9]*&#39;</span> <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$((</span> <span class="va">$m</span> * 128 <span class="va">))</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $1 + 1}&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> -n <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/^ *\([0-9]*\) \([0-9]*\)/\2:\1/&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39;\n\&#39;</span> <span class="st">&#39; &#39;</span></a></code></pre></div>
<h3 id="学習">学習</h3>
<p>画像処理の分野での主流が分からないけど、 まあ、分類といえばSVMでしょ.</p>
<ul>
<li><a href="http://svmlight.joachims.org/">SVM-Light Support Vector Machine</a></li>
</ul>
<p>バイナリが配布されていてそのまま使える.</p>
<p>学習・テストデータは、 一行に一つのデータセットを書いたテキストファイル. 一つのデータセットは、</p>
<pre><code>&lt;target&gt;\t&lt;1-origin id&gt;:&lt;weight&gt;\t...&lt;1-origin id&gt;:&lt;weight&gt;</code></pre>
<p><code>&lt;target&gt;</code> はデータセットの分類結果. 学習の場合には、<code>1</code> または <code>-1</code> と書く. 結果がわからない場合には適当に書いておけばいい (<code>0</code> とか書いとけばいい?).</p>
<p><code>&lt;1-origin id&gt;:&lt;weight&gt;</code> は先ほど作ったものをそのまま用いればよい. 先ほどのでは <code>&lt;weight&gt;</code> として、そのIDの出現回数を用いた. 普通は正規化くらいするわな (<code>特徴量正規化</code>). 大抵の場合、正規化はするほうがよい.</p>
<p>改めて書くと、</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">(</span> <span class="bu">echo</span> -n <span class="st">&#39;1 &#39;</span><span class="kw">;</span> <span class="fu">cat</span> hoge <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;^ &#39;</span> <span class="kw">|</span> <span class="fu">grep</span> -o <span class="st">&#39;[0-9]*&#39;</span> <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$((</span> <span class="va">$m</span> * 128 <span class="va">))</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $1 + 1}&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> -n <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/^ *\([0-9]*\) \([0-9]*\)/\2:\1/&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39;\n&#39;</span> <span class="st">&#39; &#39;</span> <span class="kw">;</span> <span class="bu">echo</span> <span class="kw">)</span> <span class="op">&gt;</span> <span class="ex">train</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="ex">svm_learn</span> ./train</a></code></pre></div>
<p>って感じ (これは訓練事例1つだけで訓練したもの).</p>
<p>道具は揃ったので、あとはやってみるだけ. 画像は元々持ってるのを使う.</p>
<p>「ゆゆ式」の画像54枚をポジティブとする. (キャラクターじゃなくてアニメを直接ターゲットとするのは、 本当はどうかと思う) 思ったより手持ちが少なかった. ネガティブ（「ゆゆ式」ではない画像）はいくらでもあるのだけど、 ポジティブに対して極端にネガティブが多いと良くないので、 同じ54枚だけ使うことにする.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="va">m=</span>70</a>
<a class="sourceLine" id="cb16-4" title="4"></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="bu">:</span> <span class="op">&gt;</span> ./train</a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="va">target=</span>1</a>
<a class="sourceLine" id="cb16-8" title="8"><span class="kw">for</span> <span class="ex">f</span> in <span class="kw">`</span><span class="fu">cat</span> posimgs<span class="kw">`;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-9" title="9">  <span class="ex">convert</span> -resize 200x200! -segment 1x1 +dither -colors 2 -edge 1 -negate -monochrome -compress none <span class="va">$f</span> out.ppm</a>
<a class="sourceLine" id="cb16-10" title="10">  <span class="ex">./robwhess-opensift-6233815/bin/siftfeat</span> -x -o sift.txt out.ppm</a>
<a class="sourceLine" id="cb16-11" title="11">  <span class="kw">(</span></a>
<a class="sourceLine" id="cb16-12" title="12">  <span class="bu">echo</span> -n <span class="st">&quot;</span><span class="va">$target</span><span class="st"> &quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb16-13" title="13">  <span class="fu">cat</span> sift.txt <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;^ &#39;</span> <span class="kw">|</span> <span class="fu">grep</span> -o <span class="st">&#39;[0-9]*&#39;</span> <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$((</span> <span class="va">$m</span> * 128 <span class="va">))</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $1 + 1}&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> -n <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/^ *\([0-9]*\) \([0-9]*\)/\2:\1/&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39;\n&#39;</span> <span class="st">&#39; &#39;</span> <span class="kw">;</span></a>
<a class="sourceLine" id="cb16-14" title="14">  <span class="bu">echo</span> <span class="kw">)</span> <span class="op">&gt;&gt;</span> <span class="ex">train</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="kw">done</span></a>
<a class="sourceLine" id="cb16-16" title="16"></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="va">target=</span>-1</a>
<a class="sourceLine" id="cb16-18" title="18"><span class="kw">for</span> <span class="ex">f</span> in <span class="kw">`</span><span class="fu">cat</span> negimgs<span class="kw">`;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-19" title="19">  <span class="ex">convert</span> -resize 200x200! -segment 1x1 +dither -colors 2 -edge 1 -negate -monochrome -compress none <span class="va">$f</span> out.ppm</a>
<a class="sourceLine" id="cb16-20" title="20">  <span class="ex">./robwhess-opensift-6233815/bin/siftfeat</span> -x -o sift.txt out.ppm</a>
<a class="sourceLine" id="cb16-21" title="21">  <span class="kw">(</span></a>
<a class="sourceLine" id="cb16-22" title="22">  <span class="bu">echo</span> -n <span class="st">&quot;</span><span class="va">$target</span><span class="st"> &quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb16-23" title="23">  <span class="fu">cat</span> sift.txt <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;^ &#39;</span> <span class="kw">|</span> <span class="fu">grep</span> -o <span class="st">&#39;[0-9]*&#39;</span> <span class="kw">|</span> <span class="fu">head</span> -n <span class="va">$((</span> <span class="va">$m</span> * 128 <span class="va">))</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $1 + 1}&#39;</span> <span class="kw">|</span> <span class="fu">sort</span> -n <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/^ *\([0-9]*\) \([0-9]*\)/\2:\1/&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39;\n&#39;</span> <span class="st">&#39; &#39;</span> <span class="kw">;</span></a>
<a class="sourceLine" id="cb16-24" title="24">  <span class="bu">echo</span> <span class="kw">)</span> <span class="op">&gt;&gt;</span> <span class="ex">train</span></a>
<a class="sourceLine" id="cb16-25" title="25"><span class="kw">done</span></a>
<a class="sourceLine" id="cb16-26" title="26"></a>
<a class="sourceLine" id="cb16-27" title="27"><span class="ex">svm_learn</span> ./train a.model</a></code></pre></div>
<pre><code>Runtime for XiAlpha-estimates in cpu-seconds: 0.00
XiAlpha-estimate of the error: error&lt;=93.58% (rho=1.00,depth=0)
XiAlpha-estimate of the recall: recall=&gt;7.27% (rho=1.00,depth=0)
XiAlpha-estimate of the precision: precision=&gt;7.27% (rho=1.00,depth=0)
Number of kernel evaluations: 3822</code></pre>
<p>全然ダメと読む.</p>
<p><code>convert</code> での事前処理を省いたり、 使う特徴量を増やしたりしたけど全然ダメだった</p>
<footer>
    <p class="is-pulled-right">
    @cympfh / cympfh@gmail.com
    </p>
</footer>
<!--

  以下を埋め込むと H2 タグを列挙してそれぞれへのリンクにする.
  ただし "INDEX" は除外する.

    <div id=toc></div>


  H2, H3 タグまでを列挙するには以下を埋め込む.

    <div id=toc-level-2></div>

-->
<script>
(function() {

  function naming(obj, name) {
      var PREF = document.createElement('a');
      PREF.name = name;
      obj.appendChild(PREF);
  }

  function level1() {

    var sections = document.getElementsByTagName('h2');
    var OL = document.createElement('ol');
    for (var i=0; i < sections.length; ++i) {
      var LI = document.createElement('li');
      var A = document.createElement('a');
      A.innerHTML = sections[i].innerHTML;
      if (A.innerHTML.toUpperCase() == 'INDEX') continue;
      A.href = '#' + i;
      LI.appendChild(A);
      OL.appendChild(LI);
      naming(sections[i], i);
      // var PREF = document.createElement('a');
      // PREF.name = i;
      // sections[i].appendChild(PREF);
    }

    return OL;
  }

  function level2() {

    var sections = document.querySelectorAll('h2,h3');
    var tree = [];
    for (var i = 0; i < sections.length; ++i) {
      if (sections[i].tagName == 'H2') {
        if (sections[i].innerHTML.toUpperCase() === 'INDEX') continue;
        tree.push([sections[i]]);
      } else {
        if (tree.length > 0) {
          tree[tree.length-1].push(sections[i]);
        } else {
          tree.push([sections[i]]);
        }
      }
    }

    var OL = document.createElement('ol');
    for (var i = 0; i < tree.length; ++i) {

      // h2-level
      var LI = document.createElement('li');
      var A = document.createElement('a');
      A.innerHTML = tree[i][0].innerHTML;
      A.href = '#' + i;
      naming(tree[i][0], i);
      LI.appendChild(A);

      // h3-level
      if (tree[i].length > 1) {
        var OL_sub = document.createElement('ol');
        for (var j = 1; j < tree[i].length; ++j) {
          var LI_sub = document.createElement('li');
          var A = document.createElement('a');
          A.innerHTML = tree[i][j].innerHTML;
          A.href = `#${i}-${j}`;
          naming(tree[i][j], `${i}-${j}`);
          LI_sub.appendChild(A);
          OL_sub.appendChild(LI_sub);
        }
        LI.appendChild(OL_sub);
      }

      OL.appendChild(LI);
    }

    return OL;
  }

  function append_toc() {
    if (document.getElementById('toc')) {
      document.getElementById('toc').appendChild(level1());
    }
    if (document.getElementById('toc-level-2')) {
      document.getElementById('toc-level-2').appendChild(level2());
    }
  }

  window.addEventListener('DOMContentLoaded', append_toc, false);
}());
</script>
</body>
</html>
